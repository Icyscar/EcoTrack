<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | EcoTrack</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .admin-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface);
            padding: 1rem 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            border-bottom: 4px solid var(--primary);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            color: var(--primary);
            margin: 1.5rem 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #eee;
        }

        .stakeholder-item {
            padding: 1.2rem;
            background: white;
            border-radius: 10px;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }

        .stakeholder-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .house-item {
            border-left: 6px solid var(--primary);
        }

        .agency-item {
            border-left: 6px solid var(--secondary);
        }

        .role-badge {
            font-size: 0.65rem;
            text-transform: uppercase;
            font-weight: 900;
            padding: 3px 10px;
            border-radius: 50px;
            display: inline-block;
            margin-bottom: 0.5rem;
        }

        .role-house {
            background: #e8f5e9;
            color: #1b5e20;
        }

        .role-agency {
            background: #e0f2f1;
            color: #00695c;
        }

        .btn-delete {
            background: #fff5f5;
            color: #c62828;
            border: 1px solid #ffcdd2;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 700;
            transition: background 0.2s;
        }

        .btn-delete:hover {
            background: #fee2e2;
        }

        .empty-msg {
            text-align: center;
            color: #aaa;
            padding: 2rem;
            font-style: italic;
        }

        .icon-box {
            font-size: 1.5rem;
        }
    </style>
</head>

<body onload="initAdminDashboard()">
    <div class="container">
        <nav class="nav-bar animate-fade">
            <h2 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                üõ°Ô∏è EcoTrack Master Admin
            </h2>
            <div>
                <button onclick="logout()" class="btn btn-primary" style="padding: 0.5rem 1rem;">Logout</button>
            </div>
        </nav>

        <div class="stats-row animate-fade" style="margin-top: 2rem;">
            <div class="stat-card">
                <div class="icon-box">üë§</div>
                <small>Total Households</small>
                <h2 id="totalUsers">0</h2>
            </div>
            <div class="stat-card" style="border-bottom-color: var(--secondary);">
                <div class="icon-box">üöõ</div>
                <small>Recycling Agencies</small>
                <h2 id="totalRecyclers">0</h2>
            </div>
            <div class="stat-card" style="border-bottom-color: #01579b;">
                <div class="icon-box">üìä</div>
                <small>System Waste Flow</small>
                <h2 id="systemTotalWaste">0.0 kg</h2>
            </div>
        </div>

        <div class="admin-grid">
            <!-- Account Registration -->
            <div class="animate-fade" style="animation-delay: 0.1s;">
                <div class="glass-panel" style="position: sticky; top: 2rem;">
                    <h3>‚ú® Board New Stakeholder</h3>
                    <p style="font-size: 0.9rem; color: #666; margin-bottom: 1.5rem;">Select the correct role to ensure
                        proper system access.</p>

                    <form id="adminRegForm">
                        <div class="form-group">
                            <label for="regRole">Select Stakeholder Type</label>
                            <select id="regRole" required style="border: 2px solid var(--primary); font-weight: 600;">
                                <option value="user">üè† Household Customer (Waste Generator)</option>
                                <option value="recycler">üöõ Recycling Agency (Waste Collector)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="regName">Name / Agency Title</label>
                            <input type="text" id="regName" placeholder="Full name or Legal identity" required>
                        </div>
                        <div class="form-group">
                            <label for="regEmail">Official Email</label>
                            <input type="email" id="regEmail" placeholder="auth@ecotrack.com" required>
                        </div>
                        <div class="form-group">
                            <label for="regPassword">Initial Password</label>
                            <input type="password" id="regPassword" placeholder="Minimum 6 characters" required>
                        </div>

                        <div id="recyclerFields"
                            style="display: none; background: #e0f2f1; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px dashed var(--secondary);">
                            <h4 style="margin-bottom: 1rem; color: #00695c;">Partner Specifications</h4>
                            <div class="form-group">
                                <label for="recKind">Partner Type</label>
                                <select id="recKind">
                                    <option value="agency">Recycling Agency (Fleet/Large Scale)</option>
                                    <option value="individual">Individual Partner (Micro-Recycler)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="recLocation">Primary Service Area</label>
                                <input type="text" id="recLocation" placeholder="e.g. South District, Block A">
                            </div>
                            <div class="form-group">
                                <label for="recType">Material Expertise</label>
                                <select id="recType">
                                    <option value="All">All Recyclables</option>
                                    <option value="Plastic">Plastic & Polymers</option>
                                    <option value="E-Waste">Electronics (E-Waste)</option>
                                    <option value="Organic">Organic & Biowaste</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary" style="width: 100%; font-size: 1.1rem;">Confirm &
                            Onboard Account</button>
                    </form>
                </div>
            </div>

            <!-- Stakeholders List -->
            <div class="glass-panel animate-fade" style="animation-delay: 0.2s;">
                <h3 style="margin-bottom: 0;">Stakeholder Ecosystem</h3>
                <p style="font-size: 0.85rem; color: #888; margin-bottom: 1.5rem;">Manage all active entities from this
                    panel.</p>

                <div class="section-header">
                    <span>üè† Registered Households (Generators)</span>
                    <span id="houseCount"
                        style="margin-left: auto; font-size: 0.8rem; background: #eee; padding: 2px 10px; border-radius: 10px;">0</span>
                </div>
                <div id="houseList"></div>

                <div class="section-header" style="color: var(--secondary); border-bottom-color: #b2dfdb;">
                    <span>üöõ Recycling Agencies (Collectors)</span>
                    <span id="agencyCount"
                        style="margin-left: auto; font-size: 0.8rem; background: #eee; padding: 2px 10px; border-radius: 10px;">0</span>
                </div>
                <div id="agencyList"></div>
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/waste.js"></script>
    <script>
        function initAdminDashboard() {
            const user = checkAuth();
            if (!user || user.role !== 'admin') {
                window.location.href = 'index.html';
                return;
            }
            updateAdminUI();
        }

        document.getElementById('regRole').addEventListener('change', function (e) {
            document.getElementById('recyclerFields').style.display =
                e.target.value === 'recycler' ? 'block' : 'none';
        });

        document.getElementById('adminRegForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const role = document.getElementById('regRole').value;
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            const res = registerUser(name, email, password, role);

            if (res.success) {
                if (role === 'recycler') {
                    const recyclerData = {
                        email: email,
                        kind: document.getElementById('recKind').value,
                        location: document.getElementById('recLocation').value || 'Unassigned',
                        type: document.getElementById('recType').value
                    };
                    const recyclers = JSON.parse(localStorage.getItem('ecoRecyclerDetails') || '[]');
                    recyclers.push(recyclerData);
                    localStorage.setItem('ecoRecyclerDetails', JSON.stringify(recyclers));
                }
                alert('Success: ' + name + ' is now registered as a ' + (role === 'user' ? 'Household' : 'Recycler') + '.');
                e.target.reset();
                document.getElementById('recyclerFields').style.display = 'none';
                updateAdminUI();
            } else {
                alert('Error: ' + res.message);
            }
        });

        function removeAccount(email, name) {
            if (confirm('üö® WARNING: You are about to remove ' + name + ' from the system. This action cannot be undone. Proceed?')) {
                deleteUser(email);
                updateAdminUI();
            }
        }

        function updateAdminUI() {
            const users = JSON.parse(localStorage.getItem('ecoUsers') || '[]');
            const allWaste = JSON.parse(localStorage.getItem('ecoWaste') || '[]');
            const recyclerDetails = JSON.parse(localStorage.getItem('ecoRecyclerDetails') || '[]');

            const households = users.filter(u => u.role === 'user');
            const agencies = users.filter(u => u.role === 'recycler');

            document.getElementById('totalUsers').textContent = households.length;
            document.getElementById('totalRecyclers').textContent = agencies.length;
            document.getElementById('houseCount').textContent = households.length + ' Total';
            document.getElementById('agencyCount').textContent = agencies.length + ' Active';

            let totalWeight = 0;
            allWaste.forEach(w => totalWeight += w.weight);
            document.getElementById('systemTotalWaste').textContent = totalWeight.toFixed(1) + ' kg';

            // Households
            const houseDiv = document.getElementById('houseList');
            if (households.length === 0) {
                houseDiv.innerHTML = '<div class="empty-msg">No households in ecosystem yet.</div>';
            } else {
                let html = '';
                households.reverse().forEach(u => {
                    html += `
                        <div class="stakeholder-item house-item">
                            <div>
                                <span class="role-badge role-house">üè† Household Customer</span><br>
                                <strong style="font-size: 1.1rem;">${u.name}</strong><br>
                                <small style="color: #666;">üìß ${u.email}</small>
                            </div>
                            <button onclick="removeAccount('${u.email}', '${u.name}')" class="btn-delete">Remove</button>
                        </div>
                    `;
                });
                houseDiv.innerHTML = html;
            }

            // Agencies
            const agencyDiv = document.getElementById('agencyList');
            if (agencies.length === 0) {
                agencyDiv.innerHTML = '<div class="empty-msg">No agencies onboarded.</div>';
            } else {
                let html = '';
                agencies.reverse().forEach(u => {
                    const recData = recyclerDetails.find(r => r.email === u.email);
                    const isAgency = recData ? recData.kind === 'agency' : true;
                    html += `
                        <div class="stakeholder-item agency-item">
                            <div>
                                <span class="role-badge role-agency">${isAgency ? 'üöõ Recycling Agency' : 'üö∂ Individual Partner'}</span><br>
                                <strong style="font-size: 1.1rem;">${u.name}</strong><br>
                                <small style="color: #666;">üìß ${u.email}</small>
                                ${recData ? `<br><small style="color: #00796b; font-weight: 600;">üìç ${recData.location} | üè∑Ô∏è ${recData.type}</small>` : ''}
                            </div>
                            <button onclick="removeAccount('${u.email}', '${u.name}')" class="btn-delete">Remove</button>
                        </div>
                    `;
                });
                agencyDiv.innerHTML = html;
            }
        }
    </script>
</body>

</html>